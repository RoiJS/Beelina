@if(!multipleItemsService.selectMultipleActive()) {
<app-tool-bar [title]="'GENERAL_TEXTS.BIZUAL' | translate" [showBackButton]="false">
  <mat-icon matRipple [matMenuTriggerFor]="menu">more_vert</mat-icon>
  <mat-menu #menu="matMenu">
    <button [disabled]="dataSource?.itemCount === 0 && !tableDataSource?.data?.length" mat-menu-item
      (click)="activateSelectMultiple(true)">
      <mat-icon>list</mat-icon>
      {{ 'GENERAL_TEXTS.SELECT_MULTIPLE' | translate }}
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item (click)="switchViewMode(viewModeEnum.LIST)"
      [class.active-view]="currentViewMode() === viewModeEnum.LIST">
      <mat-icon>view_list</mat-icon>
      {{ 'ORDER_TRANSACTIONS_PAGE.VIEW_OPTIONS.LIST_VIEW' | translate }}
    </button>
    <button mat-menu-item (click)="switchViewMode(viewModeEnum.TABLE)"
      [class.active-view]="currentViewMode() === viewModeEnum.TABLE">
      <mat-icon>table_view</mat-icon>
      {{ 'ORDER_TRANSACTIONS_PAGE.VIEW_OPTIONS.TABLE_VIEW' | translate }}
    </button>
  </mat-menu>
</app-tool-bar>
} @else {
<app-tool-bar [title]="multipleItemsService.selectedItemsCountLabel('TRANSACTION_SELECT_MULTIPLE_MODE.LABEL')"
  [showBackButton]="false">
  <button mat-icon-button class="toolbar-option" (click)="activateSelectMultiple(false)">
    <mat-icon matBadgeColor="warn">highlight_off</mat-icon>
  </button>

  <mat-icon matRipple [matMenuTriggerFor]="menu">more_vert</mat-icon>
  <mat-menu #menu="matMenu">
    <button [disabled]="multipleItemsService.selectedItems().length === 0" mat-menu-item (click)="markOrdersAsPaid()">
      <mat-icon>check_circle_outline</mat-icon>
      {{ 'TRANSACTION_SELECT_MULTIPLE_MODE.OPTIONS.MARK_AS_PAID_SELECTED_ORDERS' | translate }}
    </button>
    <button [disabled]="multipleItemsService.selectedItems().length === 0" mat-menu-item (click)="viewSelectedOrders()">
      <mat-icon>list</mat-icon>
      {{ 'TRANSACTION_SELECT_MULTIPLE_MODE.OPTIONS.VIEW_SELECTED_ORDERS' | translate }}
    </button>
  </mat-menu>
</app-tool-bar>
}

<app-loader-layout [busy]="orderTransactionStore.isLoading()">
  <div class="page-container scale-in-center-animation">
    <div class="page-container__page-divider scale-in-center-animation">
      <label>{{ "ORDER_TRANSACTIONS_PAGE.TITLE" | translate }}</label><br />
      <span class="page-information-description">{{
        "ORDER_TRANSACTIONS_PAGE.DESCRIPTION" | translate
        }}</span>
    </div>
    <app-search-field [filter]="true" (onSearch)="onSearch($event)" (onClear)="onClear()" (onFilter)="openFilter()"
      [filterActive]="transactionsFilter().isActive()" [placeHolderTextIdentifier]="
        'ORDER_TRANSACTIONS_PAGE.SEARCH_TEXT_FIELD.PLACEHOLDER'
      "></app-search-field>
    <div class="order-transactions-list-status-bar-container">

      @if (orderTransactionStore.filterKeyword()?.length > 0) {
      <div class="order-transactions-list-status-bar-container__search-result-counter-section">
        <span>{{ 'ORDER_TRANSACTIONS_PAGE.ORDER_TRANSACTION_LIST_SEARCH_RESULT_CONTAINER.LABEL' | translate }}: </span>
        <app-badge class="value" [type]="bannerTypeEnum.WARNING"
          [label]="orderTransactionStore.totalCount().toString()"></app-badge>
      </div>
      }
    </div>

    <!-- LIST VIEW (Virtual Scrolling) -->
    @if (currentViewMode() === viewModeEnum.LIST) {
    <app-list-container [templateType]="emptyEntityTemplateEnum.TRANSACTIONS"
      [labelInformationTextIdentifier]="'ORDER_TRANSACTIONS_PAGE.ORDER_TRANSACTION_LIST_EMPTY_LABEL.LABEL'"
      [count]="dataSource?.itemCount">

      @if(multipleItemsService.selectMultipleActive()) {
      <mat-checkbox [checked]="multipleItemsService.isSelectedAll()" (change)="selectAllItems($event.checked)"
        [labelPosition]="'after'">{{
        'GENERAL_TEXTS.SELECT_ALL' | translate }}</mat-checkbox>
      }

      <cdk-virtual-scroll-viewport itemSize="10" orientation="vertical" class="list-container order-transactions-list">

        <div *cdkVirtualFor="let item of dataSource">

          <div class="order-transactions-item-container">
            <div matRipple class="order-transactions-item-container__order-transactions-icon-container"
              (click)="viewTransaction(item)">
              <div class="order-transactions-icon">
                <mat-icon>assignment</mat-icon>
              </div>
            </div>
            <div matRipple class="order-transactions-item-container__order-transactions-info-container">
              <div class="order-transactions-info" (click)="viewTransaction(item)">
                <span class="order-transactions-info__invoice-no">{{ item.invoiceNo }}
                  @switch(item.status) {
                  @case(transactionStatusType.DRAFT) {
                  <app-badge [type]="bannerTypeEnum.INFO" [textIdentifier]="'ORDER_TYPE.DRAFT'"></app-badge>
                  }
                  @case(transactionStatusType.BAD_ORDER) {
                  <app-badge [type]="bannerTypeEnum.ERROR" [textIdentifier]="'ORDER_TYPE.BAD_ORDER'"></app-badge>
                  }
                  @case(transactionStatusType.CONFIRMED) {
                  <app-badge [type]="bannerTypeEnum.SUCCESS" [textIdentifier]="'ORDER_TYPE.CONFIRM'"></app-badge>
                  }
                  }
                </span>
                <span class="order-transactions-info__created-by">{{ item.createdBy }}</span><br>
                <span class="order-transactions-info__order-transactions-date">{{ item.transactionDateFormatted
                  }}</span><br>
                <span class="order-transactions-info__net-amount">{{ 'ORDER_TRANSACTIONS_PAGE.LIST_VIEW.NET_AMOUNT' | translate }}: {{ item.netTotalFormatted }}</span>
                @if(item.status === transactionStatusType.CONFIRMED) {
                <br>
                <span class="order-transactions-info__payment-status">
                  {{ 'ORDER_TRANSACTIONS_PAGE.LIST_VIEW.PAYMENT_STATUS' | translate }}:
                  @switch(item.paymentStatus) {
                  @case(paymentStatusType.Paid) {
                  <app-badge [type]="bannerTypeEnum.SUCCESS" [textIdentifier]="'PAYMENT_STATUS.PAID'"></app-badge>
                  }
                  @case(paymentStatusType.Unpaid) {
                  <app-badge [type]="bannerTypeEnum.ERROR" [textIdentifier]="'PAYMENT_STATUS.UNPAID'"></app-badge>
                  }
                  }
                </span>
                }
              </div>
              <div class="order-transactions-actions">

                @if(multipleItemsService.selectMultipleActive()) {
                <mat-checkbox [checked]="multipleItemsService.isSelected(item)" [id]="item.id.toString()"
                  (change)="selectItem($event.checked, $event.source.id)"></mat-checkbox>
                }

                <mat-icon (click)="viewTransaction(item)">keyboard_arrow_right</mat-icon>
              </div>
            </div>
          </div>

        </div>
      </cdk-virtual-scroll-viewport>
    </app-list-container>
    }

    <!-- TABLE VIEW (Material Table with Pagination) -->
    @if (currentViewMode() === viewModeEnum.TABLE) {
    <div class="table-container">
      @if(multipleItemsService.selectMultipleActive()) {
      <div class="table-select-all-container">
        <mat-checkbox [checked]="multipleItemsService.isSelectedAll()" (change)="selectAllTableItems($event.checked)"
          [labelPosition]="'after'">{{
          'GENERAL_TEXTS.SELECT_ALL' | translate }}</mat-checkbox>
      </div>
      }

      <div class="table-wrapper">
        <mat-table [dataSource]="tableDataSource" matSort matSortActive="transactionDate" matSortDisableClear
          matSortDirection="desc" (matSortChange)="onSortChange($event)" class="order-transactions-table">

        <!-- Select Column (for multiple selection mode) -->
        @if(multipleItemsService.selectMultipleActive()) {
        <ng-container matColumnDef="select">
          <mat-header-cell *matHeaderCellDef></mat-header-cell>
          <mat-cell *matCellDef="let row">
            <mat-checkbox [checked]="multipleItemsService.isSelected(row)"
              (change)="selectTableItem($event.checked, row)">
            </mat-checkbox>
          </mat-cell>
        </ng-container>
        }

        <!-- Invoice No Column -->
        <ng-container matColumnDef="invoiceNo">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.COLUMNS.INVOICE_NO' | translate }}
          </mat-header-cell>
          <mat-cell *matCellDef="let element">
            <div class="invoice-cell">
              <span class="invoice-no">{{ element.invoiceNo }}</span>
            </div>
          </mat-cell>
        </ng-container>

        <!-- Created By Column -->
        <ng-container matColumnDef="createdBy">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.COLUMNS.CREATED_BY' | translate }}
          </mat-header-cell>
          <mat-cell *matCellDef="let element">{{ element.createdBy }}</mat-cell>
        </ng-container>

        <!-- Store Column -->
        <ng-container matColumnDef="storeName">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.COLUMNS.STORE' | translate }}
          </mat-header-cell>
          <mat-cell *matCellDef="let element">{{ element.store.name }}</mat-cell>
        </ng-container>

        <!-- Transaction Date Column -->
        <ng-container matColumnDef="transactionDate">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.COLUMNS.TRANSACTION_DATE' | translate }}
          </mat-header-cell>
          <mat-cell *matCellDef="let element">{{ element.transactionDateFormatted }}</mat-cell>
        </ng-container>

        <!-- Gross Amount Column -->
        <ng-container matColumnDef="grossAmount">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.COLUMNS.GROSS_AMOUNT' | translate }}
          </mat-header-cell>
          <mat-cell *matCellDef="let element">{{ element.grossTotalFormatted }}</mat-cell>
        </ng-container>

        <!-- Net Amount Column -->
        <ng-container matColumnDef="netAmount">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.COLUMNS.NET_AMOUNT' | translate }}
          </mat-header-cell>
          <mat-cell *matCellDef="let element">{{ element.netTotalFormatted }}</mat-cell>
        </ng-container>

        <!-- Payment Status Column -->
        <ng-container matColumnDef="paymentStatus">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.COLUMNS.PAYMENT_STATUS' | translate }}
          </mat-header-cell>
          <mat-cell *matCellDef="let element">
            @if(element.status === transactionStatusType.CONFIRMED) {
              @switch(element.paymentStatus) {
              @case(paymentStatusType.Paid) {
              <app-badge [type]="bannerTypeEnum.SUCCESS" [textIdentifier]="'PAYMENT_STATUS.PAID'"></app-badge>
              }
              @case(paymentStatusType.Unpaid) {
              <app-badge [type]="bannerTypeEnum.WARNING" [textIdentifier]="'PAYMENT_STATUS.UNPAID'"></app-badge>
              }
              }
            } @else {
              <span class="text-muted">—</span>
            }
          </mat-cell>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.COLUMNS.STATUS' | translate }}
          </mat-header-cell>
          <mat-cell *matCellDef="let element">
            @switch(element.status) {
            @case(transactionStatusType.DRAFT) {
            <app-badge [type]="bannerTypeEnum.INFO" [textIdentifier]="'ORDER_TYPE.DRAFT'"></app-badge>
            }
            @case(transactionStatusType.BAD_ORDER) {
            <app-badge [type]="bannerTypeEnum.ERROR" [textIdentifier]="'ORDER_TYPE.BAD_ORDER'"></app-badge>
            }
            @case(transactionStatusType.CONFIRMED) {
            <app-badge [type]="bannerTypeEnum.SUCCESS" [textIdentifier]="'ORDER_TYPE.CONFIRM'"></app-badge>
            }
            }
          </mat-cell>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <mat-header-cell *matHeaderCellDef>
            {{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.COLUMNS.ACTIONS' | translate }}
          </mat-header-cell>
          <mat-cell *matCellDef="let element">
            <button mat-icon-button (click)="viewTransaction(element)"
              matTooltip="{{ 'ORDER_TRANSACTIONS_PAGE.TABLE_VIEW.ACTIONS.VIEW_TRANSACTION' | translate }}">
              <mat-icon>visibility</mat-icon>
            </button>
          </mat-cell>
        </ng-container>

          <mat-header-row *matHeaderRowDef="getDisplayedColumns()"></mat-header-row>
          <mat-row *matRowDef="let row; columns: getDisplayedColumns()" class="transaction-table-row"></mat-row>
        </mat-table>
      </div>

      <!-- Paginator -->
      <mat-paginator [pageSize]="currentPageSize()" [pageIndex]="currentPageIndex()"
        [length]="orderTransactionStore.totalCount()" [pageSizeOptions]="[10, 25, 50, 100]"
        (page)="onPageChange($event)" showFirstLastButtons>
      </mat-paginator>
    </div>
    }
  </div>
</app-loader-layout>
